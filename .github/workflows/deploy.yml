name: Deploy Backend

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 65.109.168.192
          username: work
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # Exit on error

            # Navigate to backend directory
            BACKEND_DIR=~/website/flashcard-backend
            if [ ! -d "$BACKEND_DIR" ]; then
              echo "Error: Backend directory not found at $BACKEND_DIR"
              exit 1
            fi

            cd "$BACKEND_DIR"

            # Pull latest changes
            git pull origin main || git pull origin master

            # Ensure Docker network exists
            docker network create web 2>/dev/null || true

            # Rebuild backend service
            docker compose build --no-cache backend

            # Stop old container and start new one
            docker compose up -d --force-recreate backend

            # Verify container is running
            docker compose ps backend

            # Show logs if there are any issues
            docker compose logs --tail=20 backend

            echo "Backend deployment completed successfully!"
